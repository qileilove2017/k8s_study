# Azure 告警规则技术设计文档  
（Azure Alert Rules / Action Alerts）

**组件类型**：告警检测与评估引擎  
**适用架构**：Azure 企业级安全监控与自动化告警体系  
**适用环境**：金融、政企等高安全与强合规要求场景  

---

## 1. 组件定位与职责说明

Azure 告警规则（Azure Alert Rules，亦称 Action Alerts）构成 Azure Monitor 体系中的**检测与决策层**，其核心职责是持续评估监控遥测数据，并判断系统行为是否偏离既定阈值或历史基线。

在整体监控架构中：

- **告警规则负责“是否异常”**
- **Action Group 负责“如何响应”**

这种职责分离的设计确保了检测逻辑具备稳定性与可审计性，同时使响应策略能够独立演进。

---

## 2. 设计目标

Azure 告警规则的设计需满足以下目标：

- **及时发现异常，同时避免告警泛滥**  
- **评估逻辑确定、可审计、可复现**  
- **明确严重级别，支撑分级响应体系**  
- **与通知和自动化机制保持最小耦合**  

---

## 3. 告警规则类型与适用场景

Azure 告警规则根据数据来源与评估模型的不同，主要分为以下三类。

### 3.1 指标告警（Metric Alerts）

**说明**：  
指标告警用于评估 Azure 资源输出的数值型时间序列数据。

**典型场景**：
- CPU、内存、磁盘使用率  
- 网络吞吐量、连接数  
- 平台级健康指标  

**关键特性**：
- 评估频率：秒级至分钟级  
- 延迟低、执行成本可控  
- 适合基础设施与平台层监控  

---

### 3.2 日志查询告警（Log Search Alerts）

**说明**：  
日志查询告警基于 Kusto Query Language（KQL），对 Log Analytics 中的日志数据执行查询并评估结果。

**典型场景**：
- 异常率统计与趋势分析  
- 业务交易失败检测  
- 跨日志表的关联与模式识别  

**关键特性**：
- 支持复杂逻辑、Join 与聚合  
- 可引入业务语义进行判断  
- 计算成本高于指标告警  

---

### 3.3 智能检测告警（Smart Detection）

**说明**：  
智能检测告警利用 Azure 内置机器学习模型，基于历史数据自动学习正常行为基线，并识别异常模式。

**典型场景**：
- 失败请求数突增  
- 响应时间异常漂移  
- 未被显式建模的未知异常  

**关键特性**：
- 几乎无需人工配置  
- 能适应业务行为变化  
- 适合作为确定性告警的补充，而非替代  

---

## 4. 告警评估模型

### 4.1 评估生命周期

1. 遥测数据通过私有链路完成采集  
2. 告警规则按配置周期执行评估  
3. 将结果与阈值或基线进行对比  
4. 触发告警状态变更（`Activated` / `Fired` / `Resolved`）  
5. 状态变更时触发 Action Group  

告警规则本身不负责发送通知，仅负责**状态判定**。

---

### 4.2 评估频率与权衡

评估频率需要在**实时性**与**成本控制**之间取得平衡：

- 高频评估可提升响应速度，但增加计算与查询成本  
- 低频评估可降低成本，但可能延迟异常发现  

企业级常见实践为：

- **指标告警**：1–5 分钟  
- **日志查询告警**：≥5 分钟（取决于查询复杂度）  

---

## 5. 严重级别（Severity）划分策略

告警规则必须在检测阶段明确严重级别，以支撑下游分级响应逻辑。

### 推荐严重级别定义

- **Sev0（Critical）**  
  直接影响核心服务可用性或存在数据丢失风险

- **Sev1（Error）**  
  功能性退化，需要尽快人工或自动介入

- **Sev2（Warning）**  
  早期风险信号或非阻断性异常

严重级别的判定属于**检测逻辑的一部分**，而非响应逻辑。

---

## 6. 告警噪声控制与质量治理

为防止告警疲劳并保持告警可信度，告警规则必须进行合理调优。

### 推荐实践

- 使用**时间窗口聚合**避免瞬时抖动  
- 设置**最小触发次数或持续时间**  
- 通过告警状态机制实现去重  
- 避免对同一症状配置多个重复告警  

高质量告警应当是**少而准、可执行、值得信任的**。

---

## 7. 安全与合规设计要点

### 7.1 私有化数据评估

所有告警评估必须基于通过 Private Endpoint 与 AMPLS 采集的遥测数据。  
在受监管环境中，不允许使用任何公网数据摄取路径。

---

### 7.2 数据最小化原则

告警规则应仅查询**完成判断所必需的字段**。

在日志查询告警中，必须使用 KQL 的 `project-away` 明确剔除敏感字段，防止敏感信息进入告警负载并向下游传播。

---

## 8. 与 Action Group 的集成关系

告警规则与 Action Group 紧密协作，但在职责上完全解耦。

### 集成特性

- 每条告警规则可绑定一个或多个 Action Group  
- Action Group 仅在告警状态变更时触发  
- 告警负载统一使用 Common Alert Schema（V2）  

该设计确保通知与自动化流程的一致性与可扩展性。

---

## 9. 基础设施即代码（IaC）与治理要求

### 9.1 IaC 管理要求

所有告警规则必须通过 Terraform 或 Bicep 进行定义和管理。

禁止行为包括：

- 直接在 Azure Portal 中手工创建或修改  
- 不同环境间复制粘贴配置  

其目的在于确保：

- 环境一致性  
- 版本可追溯性  
- 审计合规性  

---

### 9.2 变更管理

任何对告警规则的修改都应被视为**生产级变更**，包括但不限于：

- 阈值调整  
- 查询逻辑变更  
- 严重级别重新划分  

变更应纳入评审、测试与受控发布流程。

---

## 10. 架构级最佳实践总结

- 告警规则负责定义“何时出现问题”，而非“如何解决问题”  
- 确定性告警是可靠监控体系的基础  
- 智能检测应作为补充而非替代  
- 严重级别必须在检测阶段确定  
- 优秀的告警应当是稀缺的、可执行的、值得信任的  

---
